<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>クイズ画面</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      background: #f0f0f0;
      text-align: center;
    }
    #nameInputArea {
      margin-bottom: 20px;
    }
    #nameInput {
      padding: 8px;
      font-size: 1.2em;
    }
    #quizArea {
      display: none;
    }
    .question {
      font-size: 1.6em;
      margin-bottom: 20px;
      font-weight: 700;
    }
    .choices button {
      display: block;
      width: 60%;
      margin: 10px auto;
      font-size: 1.3em;
      padding: 12px;
      cursor: pointer;
      border-radius: 5px;
      border: 1px solid #444;
      background-color: #fff;
      transition: background-color 0.3s;
    }
    .choices button:hover:not(:disabled) {
      background-color: #e0e0e0;
    }
    .choices button:disabled {
      background-color: #ccc;
      cursor: default;
    }
    #standby {
      font-size: 1.4em;
      margin-top: 20px;
      color: #666;
      display: none;
    }
    #result {
      font-size: 1.6em;
      margin-top: 30px;
      font-weight: 700;
    }
  </style>
</head>
<body>
  <h1>クイズ大会</h1>

  <div id="nameInputArea">
    <p>名前を入力してください：</p>
    <input type="text" id="nameInput" maxlength="20" />
    <button id="registerBtn">登録</button>
  </div>

  <div id="quizArea">
    <div class="question" id="questionText"></div>
    <div class="choices" id="choices"></div>
    <div id="standby">回答を送信しました。スタンバイ中...</div>
    <div id="result"></div>
  </div>

  <script>
    (() => {
      const socket = io();

      let userName = '';
      let questionStartTime = 0;

      const nameInputArea = document.getElementById('nameInputArea');
      const nameInput = document.getElementById('nameInput');
      const registerBtn = document.getElementById('registerBtn');
      const quizArea = document.getElementById('quizArea');
      const questionText = document.getElementById('questionText');
      const choicesDiv = document.getElementById('choices');
      const standbyDiv = document.getElementById('standby');
      const resultDiv = document.getElementById('result');

      function enableChoices(enabled) {
        const buttons = choicesDiv.querySelectorAll('button');
        buttons.forEach(btn => {
          btn.disabled = !enabled;
        });
      }

      registerBtn.addEventListener('click', () => {
        const val = nameInput.value.trim();
        if (!val) {
          alert('名前を入力してください');
          return;
        }
        userName = val;
        nameInputArea.style.display = 'none';
        quizArea.style.display = 'block';
      });

      // サーバーからの問題出題
      socket.on('question', data => {
        // 初期化
        resultDiv.textContent = '';
        standbyDiv.style.display = 'none';

        if (!data || !data.question || !Array.isArray(data.choices)) {
          questionText.textContent = '問題データが正しくありません';
          choicesDiv.innerHTML = '';
          return;
        }

        questionText.textContent = data.question;

        // 選択肢ボタン生成
        choicesDiv.innerHTML = '';
        data.choices.forEach(choice => {
          const btn = document.createElement('button');
          btn.textContent = choice;
          btn.onclick = () => {
            const elapsed = Date.now() - questionStartTime;
            socket.emit('answer', { name: userName, choice, elapsed });
            enableChoices(false);
            standbyDiv.style.display = 'block';
          };
          choicesDiv.appendChild(btn);
        });
        enableChoices(true);
        questionStartTime = Date.now();
      });

      // 回答受付終了などの合図
      socket.on('go', () => {
        // 問題受信を待つスタンバイ状態にする
        questionText.textContent = '問題を待っています...';
        choicesDiv.innerHTML = '';
        standbyDiv.style.display = 'none';
        resultDiv.textContent = '';
      });

      // 正解発表
      socket.on('result', data => {
        if (!data || !data.correctAnswer) return;

        const userAnswer = data.userAnswer; // クライアントが送った回答（あれば）
        const correctAnswer = data.correctAnswer;

        // 結果表示
        if (userAnswer === undefined) {
          resultDiv.textContent = `正解は「${correctAnswer}」です`;
        } else if (userAnswer === correctAnswer) {
          resultDiv.textContent = '正解です！🎉';
          resultDiv.style.color = 'green';
        } else {
          resultDiv.textContent = `不正解です... 正解は「${correctAnswer}」`;
          resultDiv.style.color = 'red';
        }
        standbyDiv.style.display = 'none';
        enableChoices(false);
      });

      // 接続エラーなどのハンドリング（簡易版）
      socket.on('connect_error', () => {
        alert('サーバーへの接続に失敗しました。ページをリロードしてください。');
      });
    })();
  </script>
</body>
</html>
